<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚­ãƒ£ãƒ©ã‚¹ãƒˆ ã‚²ãƒ¼ãƒ å†…æ™‚é–“</title>
    
    <style>
        /* â˜…ä¿®æ­£ç‚¹: box-sizingã¨paddingã‚’è¿½åŠ ã—ã€ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã */
        * {
            box-sizing: border-box; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #333333;
            color: #eeeeee;
            margin: 0;
            padding: 20px; /* â˜…ä½™ç™½ã‚’ç¢ºä¿ */
            min-height: 100vh;
        }

        #startOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #222;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #startButton {
            padding: 20px 40px;
            font-size: 2em;
            font-weight: bold;
            color: #fff;
            background-color: #4CAF50;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s, background-color 0.3s;
        }
        #startButton:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        #startButton:active {
            transform: scale(0.95);
        }
        .start-note {
            margin-top: 20px;
            color: #aaa;
            font-size: 1em;
        }

        #mainContent {
            display: none; 
        }

        #gameTimeDisplay {
            font-size: 5em;
            font-weight: bold;
            letter-spacing: 5px;
            background-color: #2a2a2a;
            padding: 30px 40px;
            border-radius: 15px;
            display: inline-block;
            box-shadow: 0 8px 15px rgba(0,0,0,0.5);
            transition: color 0.5s ease;
            margin-bottom: 20px; 
            margin-top: 30px;
        }
        .label {
            font-size: 1.4em;
            color: #b0b0b0;
            margin-bottom: 20px;
        }
        
        .controls-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
            max-width: 1200px; 
            margin: 0 auto;
        }

        #syncToggleBtn {
            padding: 12px 20px;
            margin-bottom: 20px; 
            background-color: #555;
            color: white;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            transition: background-color 0.3s;
            display: block; 
            margin-left: auto;
            margin-right: auto;
        }
        #syncToggleBtn:hover {
            background-color: #666;
        }
        
        #syncSettings {
            display: none; 
            width: 100%; 
            margin-bottom: 20px; 
            display: flex;
            justify-content: center;
        }
        
        .sync-controls, .alarm-controls {
            padding: 20px;
            background-color: #444;
            border-radius: 8px;
            width: calc(50% - 10px); 
            min-width: 300px;
            margin: 10px 0;
        }
        /* â˜…ä¿®æ­£: é€šçŸ¥è¨­å®šã‚’ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã¨åŒã˜å¹…ã«ã™ã‚‹ */
        .notification-controls {
            padding: 20px;
            background-color: #444;
            border-radius: 8px;
            width: calc(50% - 10px); 
            min-width: 300px;
            margin: 10px 0;
        }
        .notification-setting {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }


        input[type="time"], button {
            padding: 10px;
            font-size: 1.1em;
            border-radius: 5px;
            border: none;
            margin: 5px;
        }
        
        .toggle-container {
            position: relative;
            display: inline-block;
            width: 50px; 
            height: 24px;
            vertical-align: middle;
        }
        .toggle-container input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc; 
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-container input:checked + .slider {
            background-color: #4CAF50; 
        }
        .toggle-container input:checked + .slider:before {
            transform: translateX(26px); 
        }

        .status-text {
            font-weight: bold;
            font-size: 1em;
            width: 35px; 
            text-align: center;
            padding: 2px 0;
        }
        .status-on {
            color: #4CAF50; 
        }
        .status-off {
            color: #F44336; 
        }
        
        .sync-controls button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .add-alarm-btn {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
            width: calc(50% - 7px);
            margin-top: 15px;
        }
        #resetAlarmsBtn {
            background-color: #777; 
            color: white;
            cursor: pointer;
            font-weight: bold;
            width: calc(50% - 7px);
            margin-top: 15px;
        }
        #testAlarmBtn {
            background-color: #FFC107; 
            color: #333;
            cursor: pointer;
            width: 100%; 
            margin-top: 15px;
        }
        .delete-alarm-btn {
            background-color: #f44336;
            color: white;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 0.9em;
            margin: 0; 
        }

        .alarm-slot {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 5px;
        }
        .alarm-slot input[type="time"] { 
            width: 100px; 
            text-align: center;
            margin-right: 10px;
        }
        .note { 
            color: #FFA07A; 
            margin-top: 20px; 
            font-size: 0.9em; 
        }

        /* â˜…ãƒ¢ãƒã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ”¹å–„ */
        @media (max-width: 768px) {
            body {
                padding: 10px; 
            }
            #gameTimeDisplay {
                font-size: 4em;
            }
            .controls-container {
                flex-direction: column; 
                align-items: center;
                gap: 0;
            }
            
            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å…¨ã¦90%å¹…ã§ç¸¦ç©ã¿ */
            .sync-controls, .alarm-controls, .notification-controls {
                width: 90%; 
                min-width: auto;
                margin: 10px 0;
            }

            .alarm-slot input[type="time"] {
                width: 110px; 
            }
            #syncSettings {
                width: 100%;
                justify-content: center;
            }
            .sync-controls {
                 width: 90%;
                 margin: 0;
            }
            .add-alarm-btn, #resetAlarmsBtn {
                 width: 100%;
                 margin: 5px 0;
            }
        }
    </style>

</head>
<body>

    <div id="startOverlay">
        <button id="startButton" onclick="startClock()">æ™‚è¨ˆã‚’èµ·å‹•</button>
        <p class="start-note">â€» ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„</p>
    </div>

    <div id="mainContent">
        <div class="label">CARAVAN STORIES - GAME TIME</div>
        <div id="gameTimeDisplay">--:--</div>

        <button id="syncToggleBtn" onclick="toggleSyncSettings()">ã‚²ãƒ¼ãƒ å†…æ™‚é–“åŒæœŸè¨­å®šã‚’è¡¨ç¤º</button>

        <div class="controls-container">
            <div id="syncSettings">
                <div class="sync-controls">
                    <div class="label" style="font-size:1.1em;">æ™‚è¨ˆã®åŸºæº–åŒæœŸ</div>
                    <input type="time" id="gameTimeInput" value="00:00" required>
                    <button onclick="syncGameTime()">åŒæœŸ & ä¿å­˜</button>
                    <p id="statusMessage" class="note"></p>
                </div>
            </div>

            <div class="alarm-controls">
                <div class="label" style="font-size:1.1em; margin-bottom:10px;">ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®š (ã‚²ãƒ¼ãƒ å†…æ™‚é–“)</div>
                <div id="alarmListContainer" style="margin-top: 15px;"></div>
                <div style="display: flex; justify-content: space-between; gap: 10px;">
                    <button class="add-alarm-btn" onclick="addAlarmSlot()">+ ã‚¢ãƒ©ãƒ¼ãƒ è¿½åŠ </button>
                    <button id="resetAlarmsBtn" onclick="resetAlarms()">ã‚¢ãƒ©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div class="notification-controls">
                 <div class="label" style="font-size:1.1em; margin-bottom:10px;">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—/ã‚¹ãƒãƒ›é€šçŸ¥è¨­å®š</div>
                 <div class="notification-setting">
                    <p id="notificationStatusText" class="status-text status-off">OFF</p>
                    <label class="toggle-container">
                        <input type="checkbox" id="notificationToggle" onchange="toggleNotification(this.checked)">
                        <span class="slider"></span>
                    </label>
                 </div>
                 <p id="notificationNote" class="note" style="margin-top: 10px; font-size: 0.85em; color: #aaa;">
                    â€» é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ãƒˆã‚°ãƒ«ã‚’ONã«ã—ã¦è¨±å¯ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚
                 </p>
                 <button id="testAlarmBtn" onclick="testAlarmSound()">ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ãƒ»é€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
            </div>
            </div>
    </div>
    
    <script>
        const SPEED_MULTIPLIER = 24;
        const SECONDS_PER_DAY = 24 * 3600;
        const LS_KEY_REAL_TIME = 'caravanSyncRealTimeMs';
        const LS_KEY_GAME_TIME = 'caravanSyncGameTimeSeconds';
        const LS_KEY_ALARMS = 'caravanAlarms';
        const LS_KEY_NOTIFICATION_ENABLED = 'caravanNotificationEnabled';

        const DEFAULT_ALARMS = [
            { id: 1, targetTime: "00:00", enabled: false }, 
            { id: 2, targetTime: "03:00", enabled: false }, 
            { id: 3, targetTime: "18:00", enabled: false }  
        ];

        let syncRealTimeMs = 0;
        let syncGameTimeSeconds = 0;
        let alarms = []; 
        let nextAlarmId = 1;
        let isAlarming = false;
        let alarmInterval = null; 
        
        let audioCtx;
        let activeOscillator = null; 
        let lastGameTotalSeconds = -1; 
        let currentlyRingingAlarmId = null; 
        let notificationEnabled = false; 
        let savedSyncStatus = {}; // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿æŒ

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: HH:MM ã‚’ç·ç§’æ•°ã«å¤‰æ› ---
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 2) {
                return parts[0] * 3600 + parts[1] * 60;
            }
            return 0;
        }

        // â˜…â˜…â˜… æ™‚è¨ˆèµ·å‹• & éŸ³å£°åˆæœŸåŒ– â˜…â˜…â˜…
        function startClock() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            audioCtx.resume().then(() => {
                playTone(880, 'sine', 0.1); 
                goToMainScreen();
            }).catch(e => {
                console.error("Audio resume failed:", e);
                goToMainScreen();
                alert("éŸ³å£°å†ç”Ÿã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€æ™‚è¨ˆã‚’èµ·å‹•ã—ã¾ã™ã€‚");
            });
        }

        function goToMainScreen() {
            document.getElementById('startOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            initClockSystem();
        }

        // --- ãƒ“ãƒ¼ãƒ—éŸ³ç”Ÿæˆé–¢æ•° ---
        function playTone(freq, type, duration) {
            if (!audioCtx) return;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.type = type; 
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // â˜…â˜…â˜… ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’3å›é³´ã‚‰ã—ã¦è‡ªå‹•åœæ­¢ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
        function playAlarmPattern() {
            if (!audioCtx) return;
            if (activeOscillator) return; 

            const maxRepeats = 3; // 3å›é³´ã‚‰ã™
            const toneDuration = 100; // 0.1ç§’é³´ã‚‰ã™ (ãƒŸãƒªç§’)
            const interval = 500; // 0.5ç§’é–“éš” (ãƒŸãƒªç§’)
            let currentRepeat = 0;
            
            function runPattern() {
                if (currentRepeat < maxRepeats) {
                    playTone(880, 'square', toneDuration / 1000); 
                    currentRepeat++;
                    activeOscillator = setTimeout(runPattern, interval);
                } else {
                    activeOscillator = null; 
                    // ãƒ†ã‚¹ãƒˆæ™‚ä»¥å¤–ã¯stopAlarmSound()ã‚’å‘¼ã³å‡ºã—ã€‚ä»Šå›ã¯ãƒ†ã‚¹ãƒˆãªã®ã§ä¸è¦ã€‚
                }
            }
            activeOscillator = setTimeout(runPattern, 0);
        }
        
        // â˜…â˜…â˜… stopAlarmSound é–¢æ•° â˜…â˜…â˜…
        function stopAlarmSound() {
            // 1. éŸ³ã‚’æ­¢ã‚ã€ã‚¢ãƒ©ãƒ¼ãƒ çŠ¶æ…‹ã‚’è§£é™¤
            if (activeOscillator) {
                clearTimeout(activeOscillator); 
                activeOscillator = null;
            }
            isAlarming = false;
            
            // 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ­£å¸¸ã«æˆ»ã™ (ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå‹•ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚¯ãƒªã‚¢)
            updateStatusMessageNormal();

            // 4. ã‚¿ã‚¤ãƒãƒ¼å†é–‹ã‚’å¼·åˆ¶çš„ã«å®Ÿè¡Œ
            if (alarmInterval === null) {
                alarmInterval = setInterval(updateGameTime, 1000);
                updateGameTime(); 
            }
        }
        
        // --- åˆæœŸåŒ– ---
        function initClockSystem() {
            document.getElementById('syncSettings').style.display = 'none';
            loadSyncData();
            loadAlarmsData();
            loadNotificationSetting();
            if (alarmInterval === null) {
                 alarmInterval = setInterval(updateGameTime, 1000); 
            }
            updateGameTime();
        }

        // â˜…â˜…â˜… é€šçŸ¥æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        
        function loadNotificationSetting() {
            if (!("Notification" in window)) {
                document.getElementById('notificationNote').textContent = "ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—/ã‚¹ãƒãƒ›é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚";
                document.getElementById('notificationToggle').disabled = true;
                return;
            }

            const saved = localStorage.getItem(LS_KEY_NOTIFICATION_ENABLED);
            notificationEnabled = (saved === 'true');
            
            const toggle = document.getElementById('notificationToggle');
            toggle.checked = notificationEnabled;
            updateNotificationStatus(Notification.permission);
        }

        function updateNotificationStatus(permission) {
            const statusElement = document.getElementById('notificationStatusText');
            const noteElement = document.getElementById('notificationNote');
            const toggle = document.getElementById('notificationToggle');
            
            if (permission === 'granted') {
                toggle.disabled = false;
                if (notificationEnabled) {
                    statusElement.textContent = 'ON';
                    statusElement.className = 'status-text status-on';
                    noteElement.textContent = "é€šçŸ¥ã¯ç¾åœ¨æœ‰åŠ¹ã§ã™ã€‚ãƒˆã‚°ãƒ«ã§OFFã«ã§ãã¾ã™ã€‚";
                } else {
                    statusElement.textContent = 'OFF';
                    statusElement.className = 'status-text status-off';
                    noteElement.textContent = "é€šçŸ¥ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ©Ÿèƒ½ã¯OFFã§ã™ã€‚ãƒˆã‚°ãƒ«ã‚’ONã«ã—ã¦ãã ã•ã„ã€‚";
                }
            } else if (permission === 'denied') {
                statusElement.textContent = 'DENIED';
                statusElement.className = 'status-text status-off';
                noteElement.textContent = "ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚è¨­å®šã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚";
                toggle.checked = false;
                toggle.disabled = true;
                notificationEnabled = false;
                localStorage.setItem(LS_KEY_NOTIFICATION_ENABLED, 'false');
            } else { // default (æœªè¨±å¯)
                statusElement.textContent = 'OFF';
                statusElement.className = 'status-text status-off';
                noteElement.textContent = "â€» é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ãƒˆã‚°ãƒ«ã‚’ONã«ã—ã¦è¨±å¯ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚";
                toggle.disabled = false;
            }
        }

        function requestNotificationPermission() {
            return new Promise((resolve, reject) => {
                Notification.requestPermission(function (permission) {
                    resolve(permission);
                });
            });
        }
        
        async function toggleNotification(isEnabled) {
            if (isEnabled) {
                if (Notification.permission !== 'granted') {
                    const permission = await requestNotificationPermission();
                    if (permission !== 'granted') {
                        document.getElementById('notificationToggle').checked = false;
                        notificationEnabled = false;
                        localStorage.setItem(LS_KEY_NOTIFICATION_ENABLED, 'false');
                        updateNotificationStatus(permission);
                        return;
                    }
                }
                notificationEnabled = true;
                localStorage.setItem(LS_KEY_NOTIFICATION_ENABLED, 'true');
            } else {
                notificationEnabled = false;
                localStorage.setItem(LS_KEY_NOTIFICATION_ENABLED, 'false');
            }
            updateNotificationStatus(Notification.permission);
        }

        function showDesktopNotification(title, body) {
            if (notificationEnabled && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://example.com/icon.png', // ä»»æ„ã®ã‚¢ã‚¤ã‚³ãƒ³URLã«å¤‰æ›´
                    requireInteraction: true 
                });

                notification.onclick = function(event) {
                    event.preventDefault(); 
                    window.focus();
                    this.close();
                }
            }
        }
        // â˜…â˜…â˜… é€šçŸ¥æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ çµ‚äº† â˜…â˜…â˜…


        // --- ã‚¢ãƒ©ãƒ¼ãƒ ãƒªã‚¹ãƒˆã®æç”» ---
        function renderAlarms() {
            const container = document.getElementById('alarmListContainer');
            container.innerHTML = alarms.map(alarm => `
                <div class="alarm-slot" id="alarm-${alarm.id}" style="background-color: ${alarm.enabled ? '#3a3a3a' : '#555555'};">
                    <div>
                        <input type="time" value="${alarm.targetTime}" required onchange="updateAlarmTime(${alarm.id}, this.value)">
                    </div>
                    <div style="display:flex; align-items:center; gap: 15px;">
                        
                        <span class="status-text ${alarm.enabled ? 'status-on' : 'status-off'}">
                            ${alarm.enabled ? 'ON' : 'OFF'}
                        </span>
                        
                        <label class="toggle-container">
                            <input type="checkbox" id="alarm-toggle-${alarm.id}" ${alarm.enabled ? 'checked' : ''} onchange="toggleAlarmEnabled(${alarm.id}, this.checked)" style="cursor: pointer;">
                            <span class="slider"></span>
                        </label>
                        <button class="delete-alarm-btn" onclick="deleteAlarmSlot(${alarm.id})">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleSyncSettings() {
            const settingsDiv = document.getElementById('syncSettings');
            const toggleBtn = document.getElementById('syncToggleBtn');
            if (settingsDiv.style.display === 'none') {
                settingsDiv.style.display = 'flex'; 
                toggleBtn.textContent = 'ã‚²ãƒ¼ãƒ å†…æ™‚é–“åŒæœŸè¨­å®šã‚’éè¡¨ç¤º';
            } else {
                settingsDiv.style.display = 'none';
                toggleBtn.textContent = 'ã‚²ãƒ¼ãƒ å†…æ™‚é–“åŒæœŸè¨­å®šã‚’è¡¨ç¤º';
            }
        }

        function loadSyncData() {
            const savedRealTime = localStorage.getItem(LS_KEY_REAL_TIME);
            const savedGameTime = localStorage.getItem(LS_KEY_GAME_TIME);
            const statusElement = document.getElementById('statusMessage');

            if (savedRealTime && savedGameTime) {
                syncRealTimeMs = parseInt(savedRealTime, 10);
                syncGameTimeSeconds = parseInt(savedGameTime, 10);
                
                savedSyncStatus.text = 'è‡ªå‹•åŒæœŸãŒå‹•ä½œä¸­ã§ã™ã€‚';
                savedSyncStatus.color = '#90EE90';
                
            } else {
                syncRealTimeMs = new Date().getTime();
                syncGameTimeSeconds = 0;

                savedSyncStatus.text = 'åŒæœŸåŸºæº–ãŒæœªè¨­å®šã§ã™ã€‚ç¾åœ¨ã®ã‚²ãƒ¼ãƒ å†…æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                savedSyncStatus.color = '#FFA07A';
            }
            
            statusElement.textContent = savedSyncStatus.text;
            statusElement.style.color = savedSyncStatus.color;

            const initialHour = String(Math.floor(syncGameTimeSeconds / 3600)).padStart(2, '0');
            const initialMinute = String(Math.floor((syncGameTimeSeconds % 3600) / 60)).padStart(2, '0');
            document.getElementById('gameTimeInput').value = `${initialHour}:${initialMinute}`;
        }
        
        function loadAlarmsData() {
            const savedAlarms = localStorage.getItem(LS_KEY_ALARMS);
            if (savedAlarms) {
                try {
                    alarms = JSON.parse(savedAlarms).map(alarm => ({
                        id: alarm.id,
                        targetTime: alarm.targetTime,
                        enabled: alarm.enabled !== undefined ? alarm.enabled : true,
                        seconds: timeToSeconds(alarm.targetTime)
                    }));
                    const maxId = alarms.reduce((max, alarm) => Math.max(max, alarm.id), 0);
                    nextAlarmId = maxId + 1;
                } catch (e) {
                    alarms = [];
                }
            }
            if (alarms.length === 0) {
                resetAlarms(true);
                return;
            }
            renderAlarms();
        }

        function syncGameTime() {
            const inputElement = document.getElementById('gameTimeInput');
            const timeStr = inputElement.value; 
            
            const parts = timeStr.match(/^(\d{2}):(\d{2})$/); 
            
            if (!parts) {
                alert('å…¥åŠ›å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ (ä¾‹: 16:35)ã€‚');
                return;
            }
            
            const inputHour = parseInt(parts[1], 10);
            const inputMinute = parseInt(parts[2], 10);
            
            if (inputHour < 0 || inputHour > 23 || inputMinute < 0 || inputMinute > 59) {
                alert('æ™‚åˆ»ã®ç¯„å›²ãŒä¸æ­£ã§ã™ (00:00ï½23:59)ã€‚');
                return;
            }

            syncRealTimeMs = new Date().getTime();
            syncGameTimeSeconds = (inputHour * 3600) + (inputMinute * 60);
            localStorage.setItem(LS_KEY_REAL_TIME, syncRealTimeMs.toString());
            localStorage.setItem(LS_KEY_GAME_TIME, syncGameTimeSeconds.toString());
            
            lastGameTotalSeconds = syncGameTimeSeconds - 1;

            const statusElement = document.getElementById('statusMessage');
            const formattedTime = `${String(inputHour).padStart(2, '0')}:${String(inputMinute).padStart(2, '0')}`;
            
            statusElement.textContent = `åŒæœŸå®Œäº†: ã‚²ãƒ¼ãƒ å†… ${formattedTime} ã«è¨­å®šã•ã‚Œã€åŸºæº–ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`;
            statusElement.style.color = '#90EE90'; 
            
            savedSyncStatus.text = 'è‡ªå‹•åŒæœŸãŒå‹•ä½œä¸­ã§ã™ã€‚';
            savedSyncStatus.color = '#90EE90';
            
             setTimeout(() => {
                updateStatusMessageNormal();
            }, 3000); 

            updateGameTime(); 
        }
        
        function saveAlarmsData() {
            const alarmsToSave = alarms.map(alarm => ({
                id: alarm.id,
                targetTime: alarm.targetTime,
                enabled: alarm.enabled
            }));
            localStorage.setItem(LS_KEY_ALARMS, JSON.stringify(alarmsToSave));
        }
        
        function resetAlarms(isInitialLoad = false) {
            if (!isInitialLoad && !confirm('ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ï¼ˆ0æ™‚ã€3æ™‚ã€18æ™‚ã€‚å…¨ã¦åœæ­¢ï¼‰ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            alarms = DEFAULT_ALARMS.map((alarm, index) => ({
                id: index + 1,
                targetTime: alarm.targetTime,
                enabled: alarm.enabled,
                seconds: timeToSeconds(alarm.targetTime)
            }));
            nextAlarmId = DEFAULT_ALARMS.length + 1;
            saveAlarmsData();
            renderAlarms();
        }

        function addAlarmSlot() {
            if (alarms.length >= 10) return;
            const newAlarm = { 
                id: nextAlarmId++, 
                targetTime: "12:00", 
                enabled: false
            };
            newAlarm.seconds = timeToSeconds(newAlarm.targetTime); 
            alarms.push(newAlarm);
            renderAlarms();
            saveAlarmsData();
        }

        function deleteAlarmSlot(id) {
            if (alarms.length <= 1) {
                alert("ã‚¢ãƒ©ãƒ¼ãƒ ã¯æœ€ä½1ã¤æ®‹ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
                return;
            }
            alarms = alarms.filter(alarm => alarm.id !== id);
            renderAlarms();
            saveAlarmsData();
        }

        function updateAlarmTime(id, newTime) {
            const alarm = alarms.find(a => a.id === id);
            if (alarm) {
                alarm.targetTime = newTime;
                alarm.seconds = timeToSeconds(newTime); 
                saveAlarmsData();
            }
        }
        
        function toggleAlarmEnabled(id, isEnabled) {
            const alarm = alarms.find(a => a.id === id);
            if (alarm) {
                alarm.enabled = isEnabled;
                saveAlarmsData();
                renderAlarms(); 
                if (!isEnabled && isAlarming && currentlyRingingAlarmId === id) {
                    stopAlarmSound(); 
                }
            }
        }
        
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: testAlarmSoundã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ“ä½œã‚’å‰Šé™¤ â˜…â˜…â˜…
        function testAlarmSound() {
            // 1. ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã€ã‚¢ãƒ©ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (alarmInterval !== null) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            if (isAlarming) stopAlarmSound();
            
            // 2. 3å›é³´å‹•ã•ã›ã‚‹æœ¬ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
            playAlarmPattern(); 
            
            // 3. é€šçŸ¥ã‚‚ãƒ†ã‚¹ãƒˆ
            showDesktopNotification("ã‚¢ãƒ©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ", "ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ãƒ»é€šçŸ¥æ©Ÿèƒ½ãŒå‹•ä½œã—ã¦ã„ã¾ã™ã€‚");

            // 4. ãƒ†ã‚¹ãƒˆéŸ³ã®å†ç”ŸãŒå®Œå…¨ã«çµ‚ã‚ã‚‹æ™‚é–“ï¼ˆç´„1.5ç§’ï¼‰ã‚’å¾…ã£ã¦ã€æ™‚è¨ˆã‚’å†é–‹ã™ã‚‹
            setTimeout(() => {
                if (!isAlarming) {
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ“ä½œã¯è¡Œã‚ãªã„
                    if (alarmInterval === null) {
                        alarmInterval = setInterval(updateGameTime, 1000);
                    }
                }
            }, 1500); 
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ çµ‚äº† â˜…â˜…â˜…
        
        function triggerAlarm(alarmObject) {
            isAlarming = true;
            currentlyRingingAlarmId = alarmObject.id; 
            
            if (alarmInterval !== null) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }

            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = `ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå‹•ä¸­: ${alarmObject.targetTime} ğŸš¨ (3å›é³´ã£ãŸã‚‰è‡ªå‹•åœæ­¢)`;
            statusElement.style.color = '#FF0000';

            showDesktopNotification(
                "ğŸš¨ ã‚­ãƒ£ãƒ©ã‚¹ãƒˆ ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå‹•ï¼", 
                `ã‚²ãƒ¼ãƒ å†…æ™‚åˆ»ãŒ ${alarmObject.targetTime} ã«ãªã‚Šã¾ã—ãŸã€‚`
            );

            playAlarmPattern(); 
        }

        function updateStatusMessageNormal() {
             const statusElement = document.getElementById('statusMessage');
             
             statusElement.textContent = savedSyncStatus.text; 
             statusElement.style.color = savedSyncStatus.color;
        }

        // â˜…â˜…â˜… updateGameTime é–¢æ•°ï¼ˆé€£ç¶šé³´å‹•é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ â˜…â˜…â˜…
        function updateGameTime() {
            if (isAlarming && alarmInterval === null) return;
            
            const displayElement = document.getElementById('gameTimeDisplay');
            if (syncRealTimeMs === 0) {
                displayElement.textContent = '--:--'; 
                return;
            }

            const now = new Date().getTime();
            const elapsedRealTimeMs = now - syncRealTimeMs;
            const elapsedRealSeconds = elapsedRealTimeMs / 1000;
            const elapsedGameSeconds = elapsedRealSeconds * SPEED_MULTIPLIER;
            let totalGameSeconds = syncGameTimeSeconds + elapsedGameSeconds;

            totalGameSeconds %= SECONDS_PER_DAY; 
            if (totalGameSeconds < 0) totalGameSeconds += SECONDS_PER_DAY;

            const gameHour = Math.floor(totalGameSeconds / 3600);
            const remainingSeconds = totalGameSeconds % 3600;
            const gameMinute = Math.floor(remainingSeconds / 60);
            
            const formattedHour = String(gameHour).padStart(2, '0');
            const formattedMinute = String(gameMinute).padStart(2, '0');
            const currentTimeStr = `${formattedHour}:${formattedMinute}`;
            displayElement.textContent = currentTimeStr;
            
            if (gameHour >= 6 && gameHour < 18) {
                displayElement.style.color = '#FFD700';
                displayElement.style.textShadow = '0 0 10px rgba(255, 215, 0, 0.8)';
            } else {
                displayElement.style.color = '#87CEFA';
                displayElement.style.textShadow = '0 0 10px rgba(135, 206, 250, 0.8)';
            }
            
            const currentGameTotalSeconds = Math.floor(totalGameSeconds); 

            if (!isAlarming && lastGameTotalSeconds !== -1) { 
                for (const alarm of alarms) {
                    if (!alarm.enabled) continue; 

                    const alarmSeconds = alarm.seconds;

                    // ã‚¢ãƒ©ãƒ¼ãƒ é€šéåˆ¤å®š
                    const crossedCurrent = currentGameTotalSeconds >= alarmSeconds;
                    const crossedLast = lastGameTotalSeconds < alarmSeconds;
                    
                    // 00:00ã‚’ã¾ãŸãã‚±ãƒ¼ã‚¹
                    const isMidnightCrossing = (alarmSeconds === 0) && (lastGameTotalSeconds > SECONDS_PER_DAY - 60) && (currentGameTotalSeconds === 0);

                    if ((crossedCurrent && crossedLast) || isMidnightCrossing) {
                        
                        if (alarm.id !== currentlyRingingAlarmId) {
                            triggerAlarm(alarm);
                            break; 
                        }
                    }
                }
            }
            
            lastGameTotalSeconds = currentGameTotalSeconds;
            
            if (currentlyRingingAlarmId !== null) {
                 const ringingAlarm = alarms.find(a => a.id === currentlyRingingAlarmId);
                 if (ringingAlarm && currentGameTotalSeconds > ringingAlarm.seconds) {
                    currentlyRingingAlarmId = null;
                 }
            }
        }
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ çµ‚äº† â˜…â˜…â˜…
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
        window.startClock = startClock;
        window.syncGameTime = syncGameTime;
        window.addAlarmSlot = addAlarmSlot;
        window.deleteAlarmSlot = deleteAlarmSlot;
        window.updateAlarmTime = updateAlarmTime;
        window.toggleSyncSettings = toggleSyncSettings;
        window.toggleAlarmEnabled = toggleAlarmEnabled;
        window.resetAlarms = resetAlarms; 
        window.testAlarmSound = testAlarmSound; 
        window.stopAlarmSound = stopAlarmSound; 
        window.triggerAlarm = triggerAlarm;
        window.timeToSeconds = timeToSeconds; 
        window.playAlarmPattern = playAlarmPattern; 
        window.toggleNotification = toggleNotification; 
    </script> 
</body>
</html>